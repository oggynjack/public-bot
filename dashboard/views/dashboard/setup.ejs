<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'PremiumPlus Music Bot Hosting' %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'premium-400': '#f59e0b',
                        'premium-500': '#d97706',
                        'premium-600': '#b45309'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
    <!-- Navigation -->
    <nav class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-music text-premium-400 text-2xl mr-3"></i>
                    <span class="text-xl font-bold">PremiumPlus</span>
                </div>
                <div class="flex items-center space-x-4">
                    <% if (user) { %>
                        <span class="text-gray-300">Welcome, <%= user.username %></span>
                        <% if (isAdmin) { %>
                            <a href="/admin" class="text-premium-400 hover:text-premium-300 transition-colors duration-200">
                                <i class="fas fa-crown mr-2"></i>Admin
                            </a>
                        <% } %>
                        <a href="/logout" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition-colors duration-200">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </a>
                    <% } %>
                </div>
            </div>
        </div>
    </nav>

<div class="min-h-screen bg-gray-900 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-gradient-to-r from-discord-600 to-premium-600 rounded-lg p-6 mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">Bot Setup</h1>
            <p class="text-gray-200">
                Set up your Discord music bot with PremiumPlus hosting. 
                Follow the steps below to get your bot online in minutes.
            </p>
        </div>

        <!-- Setup Form -->
        <div class="bg-gray-800 rounded-lg border border-gray-700">
            <!-- Progress Indicator -->
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-discord-500 text-white rounded-full flex items-center justify-center font-semibold">1</div>
                        <span class="text-white font-medium">Bot Configuration</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gray-600 text-gray-400 rounded-full flex items-center justify-center font-semibold">2</div>
                        <span class="text-gray-400">Hosting Setup</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="w-8 h-8 bg-gray-600 text-gray-400 rounded-full flex items-center justify-center font-semibold">3</div>
                        <span class="text-gray-400">Complete</span>
                    </div>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div class="bg-discord-500 h-2 rounded-full w-1/3"></div>
                </div>
            </div>

            <!-- Form Content -->
            <div class="p-6">
                <form id="botSetupForm" class="space-y-6">
                    <!-- Bot Token -->
                    <div>
                        <label for="botToken" class="block text-sm font-medium text-gray-300 mb-2">
                            Discord Bot Token *
                            <span class="text-xs text-gray-400 ml-2">(This will be encrypted and stored securely)</span>
                        </label>
                        <div class="relative">
                            <input 
                                type="password" 
                                id="botToken" 
                                name="botToken" 
                                required
                                class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-discord-500 focus:border-transparent transition-all duration-200"
                                placeholder="Your bot token (starts with MTg4NjIyNDgzNDk4NTI2NzIw...)"
                            >
                            <button 
                                type="button" 
                                onclick="togglePasswordVisibility('botToken')"
                                class="absolute right-3 top-3 text-gray-400 hover:text-white transition-colors duration-200"
                            >
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">
                            Get your bot token from the 
                            <a href="https://discord.com/developers/applications" target="_blank" class="text-discord-400 hover:text-discord-300">Discord Developer Portal</a>
                        </p>
                    </div>

                    <!-- Application ID -->
                    <div>
                        <label for="applicationId" class="block text-sm font-medium text-gray-300 mb-2">
                            Discord Application ID *
                        </label>
                        <input 
                            type="text" 
                            id="applicationId" 
                            name="applicationId" 
                            required
                            pattern="[0-9]{17,19}"
                            class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-discord-500 focus:border-transparent transition-all duration-200"
                            placeholder="123456789012345678"
                        >
                        <p class="text-xs text-gray-400 mt-1">
                            This is the same as your bot's user ID (18-19 digit number)
                        </p>
                    </div>

                    <!-- Bot Name -->
                    <div>
                        <label for="botName" class="block text-sm font-medium text-gray-300 mb-2">
                            Bot Display Name
                            <span class="text-xs text-gray-400 ml-2">(Optional - can be changed later)</span>
                        </label>
                        <input 
                            type="text" 
                            id="botName" 
                            name="botName" 
                            class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-discord-500 focus:border-transparent transition-all duration-200"
                            placeholder="<%= user.username %>'s Music Bot"
                            value="<%= user.username %>'s Music Bot"
                        >
                    </div>

                    <!-- Terms Acceptance -->
                    <div class="flex items-start space-x-3">
                        <input 
                            type="checkbox" 
                            id="acceptTerms" 
                            name="acceptTerms" 
                            required
                            class="mt-1 w-4 h-4 text-discord-600 bg-gray-700 border-gray-600 rounded focus:ring-discord-500 focus:ring-2"
                        >
                        <label for="acceptTerms" class="text-sm text-gray-300">
                            I agree to the 
                            <a href="/terms" target="_blank" class="text-discord-400 hover:text-discord-300">Terms of Service</a> 
                            and 
                            <a href="/privacy" target="_blank" class="text-discord-400 hover:text-discord-300">Privacy Policy</a>
                        </label>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-end space-x-4">
                        <a href="/dashboard/plans" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition-colors duration-200">
                            Back to Plans
                        </a>
                        <button 
                            type="submit" 
                            id="setupButton"
                            class="px-8 py-3 bg-discord-500 hover:bg-discord-600 text-white rounded-lg font-semibold transition-colors duration-200 flex items-center space-x-2"
                        >
                            <i class="fas fa-rocket"></i>
                            <span>Setup Bot</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Help Section -->
        <div class="bg-gray-800 rounded-lg border border-gray-700 mt-8">
            <div class="p-6">
                <h2 class="text-xl font-semibold text-white mb-4">
                    <i class="fas fa-question-circle text-discord-400 mr-2"></i>
                    Need Help Getting Your Bot Token?
                </h2>
                
                <div class="space-y-4">
                    <div class="bg-gray-700 rounded-lg p-4">
                        <h3 class="font-medium text-white mb-2">Step 1: Create Discord Application</h3>
                        <p class="text-gray-300 text-sm mb-2">
                            Go to the <a href="https://discord.com/developers/applications" target="_blank" class="text-discord-400 hover:text-discord-300">Discord Developer Portal</a> and click "New Application"
                        </p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-4">
                        <h3 class="font-medium text-white mb-2">Step 2: Create Bot</h3>
                        <p class="text-gray-300 text-sm mb-2">
                            Navigate to the "Bot" section and click "Add Bot". Confirm by clicking "Yes, do it!"
                        </p>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-4">
                        <h3 class="font-medium text-white mb-2">Step 3: Copy Token & Application ID</h3>
                        <p class="text-gray-300 text-sm mb-2">
                            • Bot Token: In the Bot section, click "Copy" under the Token field<br>
                            • Application ID: In the General Information section, copy the Application ID
                        </p>
                    </div>
                    
                    <div class="bg-yellow-600 rounded-lg p-4">
                        <div class="flex items-start space-x-2">
                            <i class="fas fa-exclamation-triangle text-yellow-200 mt-1"></i>
                            <div>
                                <h3 class="font-medium text-yellow-200 mb-1">Important Security Note</h3>
                                <p class="text-yellow-100 text-sm">
                                    Never share your bot token with anyone else. Your token will be encrypted and stored securely in our database.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Setup Progress Modal -->
<div id="setupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-gray-800 rounded-2xl p-8 max-w-md w-full mx-4 border border-gray-700">
        <div class="text-center">
            <div id="setupSpinner" class="w-16 h-16 bg-discord-500 rounded-full mx-auto mb-6 flex items-center justify-center">
                <i class="fas fa-cog text-white text-2xl animate-spin"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-2">Setting up your bot...</h3>
            <p id="setupStatus" class="text-gray-400 mb-4">Validating bot token...</p>
            
            <div class="w-full bg-gray-700 rounded-full h-2 mb-4">
                <div id="setupProgress" class="bg-discord-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            
            <div id="setupSteps" class="text-left text-sm text-gray-400 space-y-2">
                <div id="step1" class="flex items-center space-x-2">
                    <i class="fas fa-circle text-xs"></i>
                    <span>Validating bot token...</span>
                </div>
                <div id="step2" class="flex items-center space-x-2 opacity-50">
                    <i class="fas fa-circle text-xs"></i>
                    <span>Creating bot instance...</span>
                </div>
                <div id="step3" class="flex items-center space-x-2 opacity-50">
                    <i class="fas fa-circle text-xs"></i>
                    <span>Starting bot service...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const icon = input.nextElementSibling.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

document.getElementById('botSetupForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        botToken: formData.get('botToken'),
        applicationId: formData.get('applicationId'),
        botName: formData.get('botName') || '<%= user.username %>\'s Music Bot'
    };
    
    // Validate inputs
    if (!data.botToken || !data.applicationId) {
        showToast('Please fill in all required fields', 'error');
        return;
    }
    
    if (!data.applicationId.match(/^\d{17,19}$/)) {
        showToast('Invalid Application ID format', 'error');
        return;
    }
    
    // Show setup modal
    showSetupModal();
    
    try {
        // Step 1: Validate token
        updateSetupProgress(1, 'Validating bot token...', 25);
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Step 2: Create instance
        updateSetupProgress(2, 'Creating bot instance...', 50);
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Step 3: Start bot
        updateSetupProgress(3, 'Starting bot service...', 75);
        
        const response = await fetch('/dashboard/setup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            updateSetupProgress(3, 'Bot setup completed!', 100, 'success');
            
            setTimeout(() => {
                window.location.href = result.redirectUrl || '/dashboard';
            }, 2000);
        } else {
            hideSetupModal();
            showToast(result.message || 'Setup failed', 'error');
        }
        
    } catch (error) {
        console.error('Setup error:', error);
        hideSetupModal();
        showToast('Setup failed. Please try again.', 'error');
    }
});

function showSetupModal() {
    document.getElementById('setupModal').classList.remove('hidden');
    document.getElementById('setupModal').classList.add('flex');
    document.body.style.overflow = 'hidden';
}

function hideSetupModal() {
    document.getElementById('setupModal').classList.add('hidden');
    document.getElementById('setupModal').classList.remove('flex');
    document.body.style.overflow = 'auto';
}

function updateSetupProgress(step, status, progress, type = 'loading') {
    document.getElementById('setupStatus').textContent = status;
    document.getElementById('setupProgress').style.width = progress + '%';
    
    // Update step indicators
    for (let i = 1; i <= 3; i++) {
        const stepEl = document.getElementById(`step${i}`);
        const icon = stepEl.querySelector('i');
        
        if (i < step) {
            stepEl.classList.remove('opacity-50');
            icon.className = 'fas fa-check-circle text-green-400 text-xs';
        } else if (i === step) {
            stepEl.classList.remove('opacity-50');
            if (type === 'success') {
                icon.className = 'fas fa-check-circle text-green-400 text-xs';
            } else {
                icon.className = 'fas fa-spinner fa-spin text-discord-400 text-xs';
            }
        }
    }
    
    // Update spinner
    if (type === 'success') {
        const spinner = document.getElementById('setupSpinner');
        spinner.innerHTML = '<i class="fas fa-check text-white text-2xl"></i>';
        spinner.classList.remove('bg-discord-500');
        spinner.classList.add('bg-green-500');
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 text-white ${
        type === 'success' ? 'bg-green-600' : 
        type === 'error' ? 'bg-red-600' : 
        'bg-blue-600'
    }`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>

</body>
</html>
